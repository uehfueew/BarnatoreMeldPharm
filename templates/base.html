<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security: CSRF Token for AJAX -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barnatore Meld Pharm</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v=6) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css', v=6) }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</head>
<body data-user-logged-in="{{ 'true' if current_user.is_authenticated else 'false' }}">

    <!-- --- MOBILE HEADER --- -->
    <header class="mobile-header">
        <div class="mobile-top-row">
            <a href="{{ url_for('main.index') }}" class="logo-text">Meld <span class="highlight">Pharm</span></a>
            <div class="mobile-header-top-right">
                <a href="{{ url_for('main.wishlist') }}" class="mobile-wishlist-btn nav-icon-btn top-row-wishlist">
                    <i class="far fa-heart"></i>
                    <span class="cart-badge-wish wishlist-count {{ 'd-none' if not wishlist_count or wishlist_count == 0 else '' }}">{{ wishlist_count if wishlist_count else 0 }}</span>
                </a>
            </div>
        </div>
        <div class="mobile-search-row">
            <div class="mobile-search-container">
                <form action="{{ url_for('main.products') }}" method="GET" class="mobile-search-form">
                    <input type="text" name="search" id="productSearchMobile" placeholder="Kërko produkte..." autocomplete="off">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>
                <div id="searchPreviewMobile" class="search-preview-dropdown"></div>
            </div>
            <a href="{{ url_for('main.wishlist') }}" class="mobile-wishlist-btn nav-icon-btn search-row-wishlist">
                <i class="far fa-heart"></i>
                <span class="cart-badge-wish wishlist-count {{ 'd-none' if not wishlist_count or wishlist_count == 0 else '' }}">{{ wishlist_count if wishlist_count else 0 }}</span>
            </a>
        </div>
    </header>

    <!-- --- DESKTOP HEADER --- -->
    <header class="desktop-header">
        <div class="container desktop-nav-container">
            <!-- Left: Logo -->
            <a href="{{ url_for('main.index') }}" class="desktop-logo">Meld <span class="highlight">Pharm</span></a>

            <!-- Center: Search Bar -->
            <div class="desktop-search">
                <form action="{{ url_for('main.products') }}" method="GET">
                    <input type="text" name="search" id="productSearch" placeholder="Kërko produkte..." autocomplete="off">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>
                <div id="searchPreview" class="search-preview-dropdown"></div>
            </div>

            <!-- Right: Icons & Profile -->
            <div class="desktop-nav-right">
                <!-- Wishlist -->
                <a href="{{ url_for('main.wishlist') }}" class="nav-icon-btn wishlist-btn-desktop" title="Lista e dëshirave">
                    <i class="far fa-heart"></i>
                    <span class="cart-badge-wish wishlist-count {{ 'd-none' if not wishlist_count or wishlist_count == 0 else '' }}">{{ wishlist_count if wishlist_count else 0 }}</span>
                </a>

                <!-- Cart -->
                <div class="cart-dropdown-wrapper">
                    <button type="button" class="nav-icon-btn cart-btn-desktop" title="Shporta" id="cartBadgeBtn" onclick="toggleMiniCart(event)">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-badge {{ 'd-none' if not cart_count or cart_count == 0 else '' }}">{{ cart_count if cart_count else 0 }}</span>
                    </button>
                    
                    <div class="mini-cart-dropdown" id="miniCart">
                        <div class="mini-cart-header">
                            <span class="items-count-text">{{ cart_count }} produkt(e)</span>
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <button class="clear-cart-btn-mini" onclick="clearCart(event)">
                                    <i class="far fa-trash-alt"></i> Fshij të gjitha
                                </button>
                                <button class="btn-close-mini" onclick="toggleMiniCart(event)"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        
                        <div class="mini-cart-items">
                            {% for item in cart_items %}
                            <div class="mini-cart-item" data-id="{{ item._id }}" onclick="window.location.href='/product/{{ item._id }}';">
                                <a href="{{ url_for('main.product_detail', product_id=item._id) }}" class="mini-cart-img-wrapper" onclick="event.stopPropagation()">
                                    <img src="{{ item.image_url }}" alt="{{ item.name }}" class="mini-cart-img">
                                </a>
                                <div class="mini-cart-info">
                                    <a href="{{ url_for('main.product_detail', product_id=item._id) }}" class="mini-item-name" onclick="event.stopPropagation()">{{ item.name }}</a>
                                    <div class="mini-item-meta">
                                        <span class="mini-item-price">€{{ "%.2f"|format(item.discount_price or item.price) }}</span>
                                        <div class="mini-qty-control" onclick="event.stopPropagation()">
                                            <button class="qty-control-btn minus" onclick="updateMiniQty(event, '{{ item._id }}', 'decrease')">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <span class="qty-val">{{ item.quantity }}</span>
                                            <button class="qty-control-btn plus" onclick="updateMiniQty(event, '{{ item._id }}', 'increase')">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button class="remove-item-btn" onclick="updateMiniQty(event, '{{ item._id }}', 'remove')" title="Hiqe">
                                    <i class="far fa-trash-alt"></i>
                                </button>
                            </div>
                            {% endfor %}
                            
                            {% if not cart_items %}
                            <div class="empty-mini-cart">
                                <i class="fas fa-shopping-basket fa-3x mb-3"></i>
                                <p>Shporta juaj është boshe.</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mini-cart-footer">
                            <a href="{{ url_for('cart.view_cart') }}" class="btn-go-to-cart">
                                SHKO NË SHPORTË ({{ "%.2f"|format(cart_total) }} €)
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="profile-section">
                    {% if current_user.is_authenticated %}
                        <button class="profile-dropdown-btn" onclick="toggleProfileDropdown()">
                            <i class="fas fa-user-circle profile-main-icon"></i>
                            <span class="user-name">{{ current_user.first_name if current_user.first_name else current_user.email.split('@')[0] }}</span>
                            <i class="fas fa-chevron-down chevron"></i>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div class="profile-dropdown" id="desktopProfileDropdown">
                            <div class="dropdown-header">
                                <p class="u-name">{{ current_user.fullname }}</p>
                                <p class="u-email">{{ current_user.email }}</p>
                            </div>
                            <ul class="dropdown-links">
                                <li><a href="{{ url_for('main.profile') }}"><i class="fas fa-user-circle"></i> Detajet e Profilit</a></li>
                                <li><a href="{{ url_for('main.address') }}"><i class="fas fa-map-marker-alt"></i> Adresa</a></li>
                                <li><a href="{{ url_for('main.orders') }}"><i class="fas fa-box"></i> Porositë</a></li>
                                <li><a href="{{ url_for('main.wishlist') }}"><i class="far fa-heart"></i> Lista e Dëshirave</a></li>
                                {% if current_user.is_admin %}
                                    <li class="admin-link"><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-shield-alt"></i> Admin Panel</a></li>
                                {% endif %}
                                <li class="logout-link"><a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i> Dil</a></li>
                            </ul>
                        </div>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="login-text-btn">Kyçu</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- --- MOBILE BOTTOM NAVIGATION --- -->
    <nav class="mobile-bottom-nav">
        <a href="{{ url_for('main.index') }}" class="bottom-nav-item {{ 'active' if request.endpoint == 'main.index' }}" onclick="closeCategoriesModal(); closeCartModal(); closeProfileModal();">
            <i class="fas fa-home"></i>
            <span>Ballina</span>
        </a>
        <button class="bottom-nav-item" onclick="openCategoriesModal()">
            <i class="fas fa-th-large"></i>
            <span>Kategoritë</span>
        </button>
        <button class="bottom-nav-item" onclick="openCartModal()">
            <div class="icon-wrapper">
                <i class="fas fa-shopping-cart"></i>
                <span class="mobile-cart-badge cart-count-badge {{ 'd-none' if not cart_count or cart_count == 0 else '' }}">{{ cart_count if cart_count else 0 }}</span>
            </div>
            <span>Shporta</span>
        </button>
        <button class="bottom-nav-item" onclick="openProfileModal()">
            <i class="fas fa-user"></i>
            <span>Profili</span>
        </button>
    </nav>

    <!-- --- MOBILE CATEGORIES MODAL --- -->
    <div id="mobile-categories-modal" class="full-screen-modal">
        <div class="modal-header">
            <h3>Kategoritë</h3>
            <button class="close-modal-btn" onclick="closeCategoriesModal()">&times;</button>
        </div>
        <div class="modal-content">
            <ul class="mobile-cat-list">
                {% if global_categories %}
                    {% for category, subcats in global_categories.items() %}
                    <li class="mobile-cat-item">
                        <div class="cat-main" onclick="toggleSubcats(this)">
                            <span>{{ category }}</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <ul class="mobile-subcat-list">
                            <li><a href="{{ url_for('main.products', category=category) }}" style="font-weight: 700; color: var(--primary);">Shiko të gjitha</a></li>
                            {% for sub in subcats %}
                            <li><a href="{{ url_for('main.products', category=category, subcategory=sub) }}">{{ sub }}</a></li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- --- MOBILE CART MODAL --- -->
    <div id="mobile-cart-modal" class="full-screen-modal">
        <div class="modal-header">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <h3>Shporta Juaj</h3>
            </div>
            <button class="close-modal-btn" onclick="closeCartModal()">&times;</button>
        </div>
        <div class="modal-content" style="padding: 0;">
            <div class="mobile-cart-items-list" style="padding: 1rem;">
                {% if cart_items %}
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                        <button onclick="clearCart(event)" class="btn-clear-all" style="background: transparent; border: none; color: #ef4444; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 0.4rem;">
                            <i class="far fa-trash-alt"></i> Fshij të gjitha
                        </button>
                    </div>

                    {% for item in cart_items %}
                    <div class="cart-item-card" data-id="{{ item._id }}" style="margin-bottom: 1rem; border: 1px solid #f1f5f9; border-radius: 16px; padding: 1rem; position: relative; display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: flex-start;">
                            <img src="{{ item.image_url }}" alt="{{ item.name }}" style="width: 70px; height: 70px; object-fit: contain; border-radius: 8px; background: #f8fafc; padding: 5px;">
                            <div style="flex: 1; padding-right: 2rem;">
                                <h4 style="font-size: 0.95rem; margin-bottom: 0.2rem; font-weight: 600; line-height: 1.3;">{{ item.name }}</h4>
                                <span style="font-size: 0.75rem; color: #64748b; font-weight: 500;">{{ item.category }}</span>
                                {% if item.size %}<span style="display: block; font-size: 0.75rem; color: #94a3b8; margin-top: 2px;">{{ item.size }}</span>{% endif %}
                                {% if item.discount_price %}
                                    <div style="color: var(--primary); font-size: 0.75rem; font-weight: 600; margin-top: 4px;">Kursimi: €{{ "%.2f"|format(item.item_savings) }}</div>
                                {% endif %}
                            </div>
                            <button class="remove-btn" onclick="updateMiniQty(event, '{{ item._id }}', 'remove')" style="position: absolute; top: 1rem; right: 1rem; background: transparent; border: none; color: #cbd5e1; font-size: 1.1rem; padding: 0.25rem;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f8fafc; padding-top: 0.75rem;">
                            <div class="price-info">
                                {% if item.discount_price %}
                                    <span style="font-size: 1.1rem; font-weight: 700; color: var(--text-main);">€{{ item.discount_price }}</span>
                                    <span style="text-decoration: line-through; color: #94a3b8; font-size: 0.85rem; margin-left: 5px;">€{{ item.price }}</span>
                                {% else %}
                                    <span style="font-size: 1.1rem; font-weight: 700; color: var(--text-main);">€{{ item.price }}</span>
                                {% endif %}
                            </div>
                            
                            <div class="quantity-selector" style="display: flex; align-items: center; background: #f1f5f9; border-radius: 10px; padding: 2px;">
                                <button class="qty-btn" onclick="updateMiniQty(event, '{{ item._id }}', 'decrease')" style="width: 32px; height: 32px; border: none; background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); color: var(--text-main);">-</button>
                                <span class="qty-val" style="padding: 0 12px; font-weight: 700; font-size: 0.95rem;">{{ item.quantity }}</span>
                                <button class="qty-btn" onclick="updateMiniQty(event, '{{ item._id }}', 'increase')" style="width: 32px; height: 32px; border: none; background: white; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); color: var(--text-main);">+</button>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; background: #f8fafc; margin: 0 -1rem -1rem -1rem; padding: 0.75rem 1rem; border-radius: 0 0 16px 16px;">
                            <span style="font-size: 0.85rem; color: #64748b; font-weight: 500;">Nëntotali:</span>
                            <span style="font-size: 1rem; font-weight: 700; color: var(--primary);">€{{ "%.2f"|format(item.item_total) }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}

                {% if not cart_items %}
                <div class="empty-cart-state-mobile">
                    <div class="icon-circle">
                        <i class="fas fa-shopping-basket"></i>
                    </div>
                    <h4>Shporta juaj është boshe</h4>
                    <p>Ju nuk keni shtuar asnjë produkt në shportë akoma.</p>
                    <button class="btn-primary-mobile" onclick="closeCartModal()">Fillo Blerjen</button>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if cart_items %}
        <div class="modal-footer-cart" style="padding: 1.25rem; border-top: 1px solid #f1f5f9; background: white;">
            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.25rem;">
                <div style="display: flex; justify-content: space-between; font-size: 0.95rem; color: #64748b;">
                    <span>Nëntotali:</span>
                    <span style="font-weight: 600; color: var(--text-main);">€{{ "%.2f"|format(cart_total) }}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.95rem; color: #64748b;">
                    <span>Transporti:</span>
                    <span style="font-weight: 600; color: var(--text-main);">{{ "€%.2f"|format(delivery_fee) if delivery_fee > 0 else "Falas" }}</span>
                </div>
                {% if cart_savings > 0 %}
                <div style="display: flex; justify-content: space-between; font-size: 0.95rem; color: var(--primary);">
                    <span>Kursimi:</span>
                    <span style="font-weight: 600;">-€{{ "%.2f"|format(cart_savings) }}</span>
                </div>
                {% endif %}
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; padding-top: 1rem; border-top: 1px solid #f8fafc;">
                    <span style="font-size: 1.1rem; font-weight: 700; color: var(--text-main);">Gjithsej:</span>
                    <span style="font-size: 1.4rem; font-weight: 800; color: var(--primary);">€{{ "%.2f"|format(grand_total) }}</span>
                </div>
            </div>
            <a href="{{ url_for('cart.checkout') }}" class="btn-checkout-mobile" style="background: var(--primary); color: white; display: block; text-align: center; padding: 1rem; border-radius: 12px; font-weight: 700; font-size: 1.1rem; text-decoration: none;">
                PROÇEDO ME POROSINË
            </a>
        </div>
        {% endif %}
    </div>

    <!-- --- MOBILE PROFILE MODAL --- -->
    <div id="mobile-profile-modal" class="full-screen-modal profile-partial">
        <div class="modal-header">
            <h3>Profili</h3>
            <button class="close-modal-btn" onclick="closeProfileModal()">&times;</button>
        </div>
        <div class="modal-content profile-modal-content">
            {% if current_user.is_authenticated %}
                <div class="user-info-card">
                    <div class="avatar-circle"><i class="fas fa-user-circle"></i></div>
                    <h4>{{ current_user.fullname }}</h4>
                    <p>{{ current_user.email }}</p>
                </div>
                
                <ul class="mobile-profile-links">
                    <li><a href="{{ url_for('main.profile') }}"><i class="fas fa-user-circle"></i> Detajet e Profilit</a></li>
                    <li><a href="{{ url_for('main.address') }}"><i class="fas fa-map-marker-alt"></i> Adresa</a></li>
                    <li><a href="{{ url_for('main.orders') }}"><i class="fas fa-box"></i> Porositë e mia</a></li>
                    <li><a href="{{ url_for('main.wishlist') }}"><i class="far fa-heart"></i> Lista e Dëshirave</a></li>
                    {% if current_user.is_admin %}
                         <li class="admin-item"><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-shield-alt"></i> Admin Panel</a></li>
                    {% endif %}
                    <li><a href="{{ url_for('auth.logout') }}" style="color: black;"><i class="fas fa-sign-out-alt"></i> Dil</a></li>
                </ul>
            {% else %}
                <div class="not-logged-in-state">
                    <i class="fas fa-user-lock"></i>
                    <p>Nuk jeni i kyçur</p>
                    <a href="{{ url_for('auth.login') }}" class="btn-primary-mobile">Kyçu</a>
                    <a href="{{ url_for('auth.register') }}" class="btn-secondary-mobile">Regjistrohu</a>
                </div>
            {% endif %}
        </div>
    </div>


    <div class="main-content">
        <!-- Flashed messages are now handled via Toasts at the bottom of the page -->
        {% block content %}{% endblock %}
    </div>

    <div id="toast-container" class="toast-container"></div>

    {% block footer %}
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Meld Pharm</h3>
                    <p>Burimi juaj i besuar për përkujdesje ndaj lëkurës dhe vitamina.</p>
                    <div class="opening-hours" style="margin-top: 1.5rem;">
                        <h4 style="color: white; font-size: 1rem; margin-bottom: 0.5rem;"><i class="far fa-clock"></i> Orari i Punës</h4>
                        <p style="margin-bottom: 0.25rem;">E Hënë - E Shtunë: <strong>08:00 - 22:00</strong></p>
                        <p>E Diel: <strong>08:00 - 21:00</strong></p>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Kontakt</h3>
                    <p><strong>Lokacioni:</strong><br>72 Eqrem Çabej, Prishtina 10000</p>
                    <p><strong>Email:</strong><br>meldpharm@gmail.com</p>
                    
                    <p style="margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;">Na kontaktoni në mediat sociale:</p>
                    <div style="display: flex; gap: 1rem;">
                        <a href="https://www.instagram.com/barnatoremeld/" target="_blank" class="social-icon instagram" title="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://www.facebook.com/profile.php?id=100067645081992" target="_blank" class="social-icon facebook" title="Facebook">
                            <i class="fab fa-facebook"></i>
                        </a>
                        <a href="https://www.tiktok.com/@barnatore.meld.ph" target="_blank" class="social-icon tiktok" title="TikTok">
                            <i class="fab fa-tiktok"></i>
                        </a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Lokacioni</h3>
                    <div class="footer-map-container" style="width: 100%; height: 200px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <iframe 
                            src="https://maps.google.com/maps?q=72%20Eqrem%20Çabej,%20Prishtina&t=&z=15&ie=UTF8&iwloc=&output=embed"
                            width="100%" 
                            height="100%" 
                            style="border:0;" 
                            allowfullscreen="" 
                            loading="lazy" 
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Barnatore Meld Pharm. Të gjitha të drejtat e rezervuara.</p>
            </div>
        </div>
    </footer>
    {% endblock %}

    <!-- Toast Logic for Flask Flash Messages -->
    <div id="flash-messages" data-messages='{{ get_flashed_messages(with_categories=true) | tojson | safe }}' style="display: none;"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
             const flashEl = document.getElementById('flash-messages');
             if (flashEl) {
                 try {
                     const messages = JSON.parse(flashEl.dataset.messages);
                     messages.forEach(([category, message], index) => {
                         setTimeout(() => {
                             if (typeof showToast === 'function') {
                                showToast(message, category);
                             }
                         }, index * 500);
                     });
                 } catch (e) {
                     console.error("Failed to parse flash messages:", e);
                 }
             }
        });
    </script>
</body>
</html>
