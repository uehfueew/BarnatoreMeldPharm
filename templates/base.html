<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security: CSRF Token for AJAX -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barnatore Meld Pharm</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v=6) }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css', v=6) }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</head>
<body data-user-logged-in="{{ 'true' if current_user.is_authenticated else 'false' }}">

    <!-- --- MOBILE HEADER --- -->
    <header class="mobile-header">
        <div class="mobile-top-row">
            <a href="{{ url_for('main.index') }}" class="logo-text">Meld <span class="highlight">Pharm</span></a>
            <div class="mobile-header-top-right">
                <a href="{{ url_for('main.wishlist') }}" class="mobile-wishlist-btn nav-icon-btn top-row-wishlist">
                    <i class="far fa-heart"></i>
                    <span class="cart-badge-wish wishlist-count {{ 'd-none' if not wishlist_count or wishlist_count == 0 else '' }}">{{ wishlist_count if wishlist_count else 0 }}</span>
                </a>
            </div>
        </div>
        <div class="mobile-search-row">
            <div class="mobile-search-container">
                <form action="{{ url_for('main.products') }}" method="GET" class="mobile-search-form">
                    <input type="text" name="search" id="productSearchMobile" placeholder="Kërko produkte..." autocomplete="off">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>
                <div id="searchPreviewMobile" class="search-preview-dropdown"></div>
            </div>
            <a href="{{ url_for('main.wishlist') }}" class="mobile-wishlist-btn nav-icon-btn search-row-wishlist">
                <i class="far fa-heart"></i>
                <span class="cart-badge-wish wishlist-count {{ 'd-none' if not wishlist_count or wishlist_count == 0 else '' }}">{{ wishlist_count if wishlist_count else 0 }}</span>
            </a>
        </div>
    </header>

    <!-- --- DESKTOP HEADER --- -->
    <header class="desktop-header">
        <div class="container desktop-nav-container">
            <!-- Left: Logo -->
            <a href="{{ url_for('main.index') }}" class="desktop-logo">Meld <span class="highlight">Pharm</span></a>

            <!-- Center: Search Bar -->
            <div class="desktop-search">
                <form action="{{ url_for('main.products') }}" method="GET">
                    <input type="text" name="search" id="productSearch" placeholder="Kërko produkte..." autocomplete="off">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>
                <div id="searchPreview" class="search-preview-dropdown"></div>
            </div>

            <!-- Right: Icons & Profile -->
            <div class="desktop-nav-right">
                <!-- Wishlist -->
                <a href="{{ url_for('main.wishlist') }}" class="nav-icon-btn wishlist-btn-desktop" title="Lista e dëshirave">
                    <i class="far fa-heart"></i>
                    <span class="cart-badge-wish wishlist-count {{ 'd-none' if not wishlist_count or wishlist_count == 0 else '' }}">{{ wishlist_count if wishlist_count else 0 }}</span>
                </a>

                <!-- Cart -->
                <div class="cart-dropdown-wrapper">
                    <button type="button" class="nav-icon-btn cart-btn-desktop" title="Shporta" id="cartBadgeBtn" onclick="toggleMiniCart(event)">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-badge {{ 'd-none' if not cart_count or cart_count == 0 else '' }}">{{ cart_count if cart_count else 0 }}</span>
                    </button>
                    
                    <div class="mini-cart-dropdown" id="miniCart">
                        <div class="mini-cart-header">
                            <span class="items-count-text">{{ cart_count }} produkt(e)</span>
                            <div style="display: flex; align-items: center; gap: 0.8rem;">
                                <button class="clear-cart-btn-mini" onclick="clearCart(event)">
                                    <i class="far fa-trash-alt"></i> Fshij të gjitha
                                </button>
                                <button class="btn-close-mini" onclick="toggleMiniCart(event)"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        
                        <div class="mini-cart-items">
                            {% for item in cart_items %}
                            <div class="mini-cart-item" data-id="{{ item._id }}" onclick="window.location.href='/product/{{ item._id }}';">
                                <a href="{{ url_for('main.product_detail', product_id=item._id) }}" class="mini-cart-img-wrapper" onclick="event.stopPropagation()">
                                    <img src="{{ item.image_url }}" alt="{{ item.name }}" class="mini-cart-img">
                                </a>
                                <div class="mini-cart-info">
                                    <a href="{{ url_for('main.product_detail', product_id=item._id) }}" class="mini-item-name" onclick="event.stopPropagation()">{{ item.name }}</a>
                                    <div class="mini-item-meta">
                                        <span class="mini-item-price">€{{ "%.2f"|format(item.discount_price or item.price) }}</span>
                                        <div class="mini-qty-control" onclick="event.stopPropagation()">
                                            <button class="qty-control-btn minus" onclick="updateMiniQty(event, '{{ item._id }}', 'decrease')">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <span class="qty-val">{{ item.quantity }}</span>
                                            <button class="qty-control-btn plus" onclick="updateMiniQty(event, '{{ item._id }}', 'increase')">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button class="remove-item-btn" onclick="updateMiniQty(event, '{{ item._id }}', 'remove')" title="Hiqe">
                                    <i class="far fa-trash-alt"></i>
                                </button>
                            </div>
                            {% endfor %}
                            
                            {% if not cart_items %}
                            <div class="empty-mini-cart">
                                <i class="fas fa-shopping-basket fa-3x mb-3"></i>
                                <p>Shporta juaj është boshe.</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mini-cart-footer">
                            <a href="{{ url_for('cart.view_cart') }}" class="btn-go-to-cart">
                                SHKO NË SHPORTË ({{ "%.2f"|format(cart_total) }} €)
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="profile-section">
                    {% if current_user.is_authenticated %}
                        <button class="profile-dropdown-btn" onclick="toggleProfileDropdown()">
                            <i class="fas fa-user-circle profile-main-icon"></i>
                            <span class="user-name">{{ current_user.first_name if current_user.first_name else current_user.email.split('@')[0] }}</span>
                            <i class="fas fa-chevron-down chevron"></i>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div class="profile-dropdown" id="desktopProfileDropdown">
                            <div class="dropdown-header">
                                <p class="u-name">{{ current_user.fullname }}</p>
                                <p class="u-email">{{ current_user.email }}</p>
                            </div>
                            <ul class="dropdown-links">
                                <li><a href="{{ url_for('main.profile') }}"><i class="fas fa-user-circle"></i> Detajet e Profilit</a></li>
                                <li><a href="{{ url_for('main.address') }}"><i class="fas fa-map-marker-alt"></i> Adresa</a></li>
                                <li><a href="{{ url_for('main.orders') }}"><i class="fas fa-box"></i> Porositë</a></li>
                                <li><a href="{{ url_for('main.wishlist') }}"><i class="far fa-heart"></i> Lista e Dëshirave</a></li>
                                {% if current_user.is_admin %}
                                    <li class="admin-link"><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-shield-alt"></i> Admin Panel</a></li>
                                {% endif %}
                                <li class="logout-link"><a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i> Dil</a></li>
                            </ul>
                        </div>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="login-text-btn">Kyçu</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- --- MOBILE BOTTOM NAVIGATION --- -->
    <nav class="mobile-bottom-nav">
        <a href="{{ url_for('main.index') }}" class="bottom-nav-item {{ 'active' if request.endpoint == 'main.index' }}" onclick="closeCategoriesModal(); closeCartModal(); closeProfileModal();">
            <i class="fas fa-home"></i>
            <span>Ballina</span>
        </a>
        <button class="bottom-nav-item" onclick="openCategoriesModal()">
            <i class="fas fa-th-large"></i>
            <span>Kategoritë</span>
        </button>
        <a href="{{ url_for('cart.view_cart') }}" class="bottom-nav-item">
            <div class="icon-wrapper">
                <i class="fas fa-shopping-cart"></i>
                <span class="mobile-cart-badge cart-count-badge {{ 'd-none' if not cart_count or cart_count == 0 else '' }}">{{ cart_count if cart_count else 0 }}</span>
            </div>
            <span>Shporta</span>
        </a>
        <button class="bottom-nav-item" onclick="openProfileModal()">
            <i class="fas fa-user"></i>
            <span>Profili</span>
        </button>
    </nav>

    <!-- --- MOBILE CATEGORIES MODAL --- -->
    <div id="mobile-categories-modal" class="full-screen-modal">
        <div class="modal-header">
            <h3>Kategoritë</h3>
            <button class="close-modal-btn" onclick="closeCategoriesModal()">&times;</button>
        </div>
        <div class="modal-content">
            <ul class="mobile-cat-list">
                {% if global_categories %}
                    {% for category, subcats in global_categories.items() %}
                    <li class="mobile-cat-item">
                        <div class="cat-main" onclick="toggleSubcats(this)">
                            <span>{{ category }}</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <ul class="mobile-subcat-list">
                            <li><a href="{{ url_for('main.products', category=category) }}" style="font-weight: 700; color: var(--primary);">Shiko të gjitha</a></li>
                            {% for sub in subcats %}
                            <li><a href="{{ url_for('main.products', category=category, subcategory=sub) }}">{{ sub }}</a></li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- --- MOBILE CART MODAL --- -->
    <div id="mobile-cart-modal" class="full-screen-modal">
        <div class="modal-header">
            <h3>Shporta Juaj</h3>
            <button class="close-modal-btn" onclick="closeCartModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="mobile-cart-items-list">
                {% if cart_items %}
                    <div class="modal-items-header">
                        <span class="items-count-badge-mobile">{{ cart_count }} produkt(e)</span>
                        <button onclick="clearCart(event)" class="btn-clear-mini">
                            <i class="far fa-trash-alt"></i> Pastro
                        </button>
                    </div>

                    {% for item in cart_items %}
                    <div class="mobile-mini-cart-item" data-id="{{ item._id }}">
                        <div class="item-main">
                            <img src="{{ item.image_url }}" alt="{{ item.name }}" class="item-img">
                            <div class="item-info">
                                <h4 class="item-name">{{ item.name }}</h4>
                                <div class="item-meta">
                                    <span class="meta-tag cat">{{ item.category }}</span>
                                    {% if item.size %}<span class="meta-tag">{{ item.size }}</span>{% endif %}
                                </div>
                                <div class="item-price-row">
                                    <div class="price-stack">
                                        {% if item.discount_price %}
                                            <span class="price-curr">€{{ item.discount_price }}</span>
                                            <span class="price-old">€{{ item.price }}</span>
                                        {% else %}
                                            <span class="price-curr">€{{ item.price }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="item-qty-selector">
                                        <button onclick="updateMiniQty(event, '{{ item._id }}', 'decrease')">-</button>
                                        <span class="qty-val">{{ item.quantity }}</span>
                                        <button onclick="updateMiniQty(event, '{{ item._id }}', 'increase')">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="item-remove-btn" onclick="updateMiniQty(event, '{{ item._id }}', 'remove')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                {% endif %}

                {% if not cart_items %}
                <div class="empty-cart-state-mobile">
                    <div class="icon-circle">
                        <i class="fas fa-shopping-basket"></i>
                    </div>
                    <h4>Shporta juaj është boshe</h4>
                    <p>Fillo blerjen duke shtuar produkte në shportë.</p>
                    <button class="btn-primary-mobile" onclick="closeCartModal()">Fillo Blerjen</button>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if cart_items %}
        <div class="modal-footer-cart">
            <div class="summary-details">
                <div class="summary-line">
                    <span>Transporti:</span>
                    <span class="delivery-fee">{{ "€%.2f"|format(delivery_fee) if delivery_fee > 0 else "Falas" }}</span>
                </div>
                <div class="summary-line total">
                    <span>Totali:</span>
                    <span class="grand-total">€{{ "%.2f"|format(grand_total) }}</span>
                </div>
            </div>
            <div class="footer-actions">
                <a href="{{ url_for('cart.view_cart') }}" class="btn-view-cart-link">Shiko Shportën</a>
                <a href="{{ url_for('cart.checkout') }}" class="btn-checkout-primary">PROÇEDO ME POROSINË</a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- --- MOBILE PROFILE MODAL --- -->
    <div id="mobile-profile-modal" class="full-screen-modal profile-partial">
        <div class="modal-header">
            <h3>Profili</h3>
            <button class="close-modal-btn" onclick="closeProfileModal()">&times;</button>
        </div>
        <div class="modal-content profile-modal-content">
            {% if current_user.is_authenticated %}
                <div class="user-info-card">
                    <div class="avatar-circle"><i class="fas fa-user-circle"></i></div>
                    <div class="user-details">
                        <h4>{{ current_user.fullname }}</h4>
                        <p>{{ current_user.email }}</p>
                    </div>
                </div>
                
                <ul class="mobile-profile-links">
                    <li><a href="{{ url_for('main.profile') }}"><i class="fas fa-user-circle"></i> Detajet e Profilit</a></li>
                    <li><a href="{{ url_for('main.address') }}"><i class="fas fa-map-marker-alt"></i> Adresa</a></li>
                    <li><a href="{{ url_for('main.orders') }}"><i class="fas fa-box"></i> Porositë e mia</a></li>
                    <li><a href="{{ url_for('main.wishlist') }}"><i class="far fa-heart"></i> Lista e Dëshirave</a></li>
                    {% if current_user.is_admin %}
                         <li class="admin-item"><a href="{{ url_for('admin.dashboard') }}"><i class="fas fa-shield-alt"></i> Admin Panel</a></li>
                    {% endif %}
                    <li><a href="{{ url_for('auth.logout') }}" style="color: black;"><i class="fas fa-sign-out-alt"></i> Dil</a></li>
                </ul>
            {% else %}
                <div class="not-logged-in-state">
                    <i class="fas fa-user-lock"></i>
                    <p>Nuk jeni i kyçur</p>
                    <a href="{{ url_for('auth.login') }}" class="btn-primary-mobile">Kyçu</a>
                    <a href="{{ url_for('auth.register') }}" class="btn-secondary-mobile">Regjistrohu</a>
                </div>
            {% endif %}
        </div>
    </div>


    <div class="main-content">
        <!-- Flashed messages are now handled via Toasts at the bottom of the page -->
        {% block content %}{% endblock %}
    </div>

    <div id="toast-container" class="toast-container"></div>

    <!-- Floating Contact Button -->
    <div class="floating-contact-wrapper">
        <div class="contact-options" id="contactOptions">
            <a href="https://m.me/100067645081992" target="_blank" class="contact-option messenger" title="Na shkruani në Messenger">
                <i class="fab fa-facebook-messenger"></i>
                <span>Messenger</span>
            </a>
            <a href="https://www.instagram.com/barnatoremeld/" target="_blank" class="contact-option instagram" title="Na shkruani në Instagram">
                <i class="fab fa-instagram"></i>
                <span>Instagram</span>
            </a>
            <!-- You can add WhatsApp here easily if you have a number -->
            <!-- <a href="https://wa.me/YOUR_NUMBER" target="_blank" class="contact-option whatsapp">...</a> -->
        </div>
        <button class="contact-main-btn" onclick="toggleContactMenu()" id="contactMainBtn">
            <i class="fas fa-comment-dots"></i>
            <i class="fas fa-times close-icon"></i>
        </button>
    </div>

    <script>
    function toggleContactMenu() {
        const wrapper = document.querySelector('.floating-contact-wrapper');
        wrapper.classList.toggle('active');
    }
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        const wrapper = document.querySelector('.floating-contact-wrapper');
        if (!wrapper.contains(e.target) && wrapper.classList.contains('active')) {
            wrapper.classList.remove('active');
        }
    });
    </script>

    <style>
    .floating-contact-wrapper {
        position: fixed;
        right: 30px;
        bottom: 30px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 15px;
    }

    .contact-main-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
    }

    .contact-main-btn:hover {
        transform: scale(1.1);
        background: var(--primary-dark);
    }

    .contact-main-btn .close-icon {
        display: none;
        position: absolute;
    }

    .floating-contact-wrapper.active .contact-main-btn {
        background: #64748b;
        transform: rotate(90deg);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .floating-contact-wrapper.active .contact-main-btn .fas:first-child {
        display: none;
    }

    .floating-contact-wrapper.active .contact-main-btn .close-icon {
        display: block;
    }

    .contact-options {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.3s ease;
    }

    .floating-contact-wrapper.active .contact-options {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .contact-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 20px;
        border-radius: 50px;
        color: white;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
        white-space: nowrap;
        width: 150px; /* Fixed width for uniform size */
        justify-content: flex-start;
    }

    .contact-option:hover {
        transform: translateX(-5px);
        filter: brightness(1.1);
    }

    .contact-option.messenger { background: #0084FF; }
    .contact-option.instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }

    @media (max-width: 768px) {
        .floating-contact-wrapper {
            right: 20px;
            bottom: 85px; /* Above mobile bottom nav */
        }
        
        /* Adjust for Product Detail sticky bar */
        body.has-sticky-bar .floating-contact-wrapper {
            bottom: 140px;
        }

        .contact-main-btn {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }
        
        .option-label {
            font-size: 0.8rem;
        }
    }
    </style>

    {% block footer %}
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Meld Pharm</h3>
                    <p>Burimi juaj i besuar për përkujdesje ndaj lëkurës dhe vitamina.</p>
                    <div class="opening-hours" style="margin-top: 1.5rem;">
                        <h4 style="color: white; font-size: 1rem; margin-bottom: 0.5rem;"><i class="far fa-clock"></i> Orari i Punës</h4>
                        <p style="margin-bottom: 0.25rem;">E Hënë - E Shtunë: <strong>08:00 - 22:00</strong></p>
                        <p>E Diel: <strong>08:00 - 21:00</strong></p>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Kontakt</h3>
                    <p><strong>Lokacioni:</strong><br>72 Eqrem Çabej, Prishtina 10000</p>
                    <p><strong>Email:</strong><br>meldpharm@gmail.com</p>
                    
                    <p style="margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;">Na kontaktoni në mediat sociale:</p>
                    <div style="display: flex; gap: 1rem;">
                        <a href="https://www.instagram.com/barnatoremeld/" target="_blank" class="social-icon instagram" title="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://www.facebook.com/profile.php?id=100067645081992" target="_blank" class="social-icon facebook" title="Facebook">
                            <i class="fab fa-facebook"></i>
                        </a>
                        <a href="https://www.tiktok.com/@barnatore.meld.ph" target="_blank" class="social-icon tiktok" title="TikTok">
                            <i class="fab fa-tiktok"></i>
                        </a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Lokacioni</h3>
                    <div class="footer-map-container" style="width: 100%; height: 200px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <iframe 
                            src="https://maps.google.com/maps?q=72%20Eqrem%20Çabej,%20Prishtina&t=&z=15&ie=UTF8&iwloc=&output=embed"
                            width="100%" 
                            height="100%" 
                            style="border:0;" 
                            allowfullscreen="" 
                            loading="lazy" 
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Barnatore Meld Pharm. Të gjitha të drejtat e rezervuara.</p>
            </div>
        </div>
    </footer>
    {% endblock %}

    <!-- Toast Logic for Flask Flash Messages -->
    <div id="flash-messages" data-messages='{{ get_flashed_messages(with_categories=true) | tojson | safe }}' style="display: none;"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
             const flashEl = document.getElementById('flash-messages');
             if (flashEl) {
                 try {
                     const messages = JSON.parse(flashEl.dataset.messages);
                     messages.forEach(([category, message], index) => {
                         setTimeout(() => {
                             if (typeof showToast === 'function') {
                                showToast(message, category);
                             }
                         }, index * 500);
                     });
                 } catch (e) {
                     console.error("Failed to parse flash messages:", e);
                 }
             }
        });
    </script>
</body>
</html>
