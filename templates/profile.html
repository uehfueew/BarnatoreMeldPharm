{% extends "base.html" %}

{% block content %}
<div class="container" style="padding-top: 2rem; padding-bottom: 5rem; min-height: 80vh;">
    <div class="profile-wrapper" style="display: grid; grid-template-columns: 350px 1fr; gap: 4rem; align-items: stretch; max-width: 1250px; margin: 0 auto;">
        
        <!-- Sidebar: User Info -->
        <aside class="profile-sidebar" style="display: flex; flex-direction: column;">
            <div style="height: 100px; border-bottom: 2px solid #f1f5f9; margin-bottom: 2.5rem; display: flex; align-items: flex-end; padding-bottom: 1.5rem;">
                <div style="text-align: left;">
                    <h2 style="font-size: 2rem; display: flex; align-items: center; gap: 1rem; margin: 0; color: var(--text-main); white-space: nowrap;">
                        <i class="fas fa-id-card" style="color: var(--primary);"></i> Profili Im
                    </h2>
                    <p class="text-muted" style="margin: 0.5rem 0 0; font-size: 1rem;">Menaxhoni profilin tuaj</p>
                </div>
            </div>

            {% if current_user.is_authenticated %}
                <div class="card user-card fade-in-section is-visible" style="padding: 2.5rem 2rem; text-align: center; border-radius: 1.5rem; box-shadow: var(--shadow-lg); background: white; border: 1px solid rgba(0,0,0,0.05); flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                    <div class="avatar" style="width: 110px; height: 110px; background: linear-gradient(135deg, var(--primary-light) 0%, #ffffff 100%); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 3.5rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); border: 4px solid white;">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1.5rem; color: var(--text-main);">{{ current_user.username }}</h3>
                    <p class="text-muted" style="margin-bottom: 2rem; font-size: 0.95rem; word-break: break-all; opacity: 0.8;">{{ current_user.email }}</p>
                    
                    {% if current_user.is_admin %}
                        <div style="margin-bottom: 2rem;">
                            <span class="badge" style="background: var(--primary); color: white; padding: 0.4rem 1.2rem; border-radius: 2rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Administrator</span>
                        </div>
                    {% endif %}

                    <div class="profile-actions" style="display: flex; flex-direction: column; gap: 1rem;">
                        <a href="{{ url_for('main.orders') }}" class="btn profile-btn-orders">
                            <i class="fas fa-shopping-bag" style="margin-right: 0.75rem;"></i> Porositë e Mia
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="btn profile-btn-logout">
                            <i class="fas fa-sign-out-alt" style="margin-right: 0.75rem;"></i> Dilni
                        </a>
                    </div>
                </div>
            {% else %}
                <div class="card guest-card fade-in-section is-visible" style="padding: 2rem; text-align: center; border-radius: 1rem; box-shadow: var(--shadow-md); background: white;">
                    <div style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;">
                        <i class="fas fa-user-secret"></i>
                    </div>
                    <h3 style="font-size: 1.25rem;">Mirë se vini</h3>
                    <p class="text-muted" style="margin-bottom: 1.5rem; font-size: 0.9rem;">Kyçuni për të ruajtur të dhënat.</p>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <a href="{{ url_for('auth.login') }}" class="btn btn-primary btn-sm">Kyçu</a>
                        <a href="{{ url_for('auth.register') }}" class="btn btn-outline-primary btn-sm">Regjistrohu</a>
                    </div>
                </div>
            {% endif %}
        </aside>

        <!-- Main Content: Favorites -->
        <main class="profile-main" style="display: flex; flex-direction: column;">
            <div style="height: 100px; border-bottom: 2px solid #f1f5f9; margin-bottom: 2.5rem; display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 1.5rem;">
                <div>
                    <h2 style="font-size: 2rem; display: flex; align-items: center; gap: 1rem; margin: 0; color: var(--text-main);">
                        <i class="fas fa-heart" style="color: #e11d48;"></i> Të Preferuarat
                    </h2>
                    <p class="text-muted" style="margin: 0.5rem 0 0; font-size: 1rem;">Produktet që keni ruajtur për më vonë</p>
                </div>
                <span style="background: var(--primary-light); color: var(--primary-dark); padding: 0.5rem 1rem; border-radius: var(--radius-full); font-weight: 600; font-size: 0.9rem;">
                    {{ favorites|length }} Produkt{{ 'e' if favorites|length != 1 else '' }}
                </span>
            </div>

            {% if favorites %}
                <div class="favorites-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem;">
                    {% for product in favorites %}
                        <div class="favorite-card fade-in-section is-visible" style="background: white; border-radius: 1.5rem; overflow: hidden; box-shadow: var(--shadow-md); border: 1px solid rgba(0,0,0,0.03); transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative;">
                            
                            <!-- Remove Button (Absolute) -->
                            <button class="remove-fav" onclick="removeFavorite(this, '{{ product._id }}')" style="position: absolute; top: 15px; right: 15px; background: white; border: none; width: 36px; height: 36px; border-radius: 50%; color: #ef4444; cursor: pointer; box-shadow: var(--shadow-md); z-index: 15; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                                <i class="fas fa-times"></i>
                            </button>

                            <!-- Image Area (Carousel) -->
                            <div class="product-image carousel-container" data-index="0" style="height: 240px; overflow: hidden; background: white; position: relative;">
                                <div class="carousel-track" style="height: 100%;">
                                    <img src="{{ product.image_url }}" alt="{{ product.name }}" style="padding: 2rem;">
                                    {% if product.images and product.images|length > 1 %}
                                        {% for extra_img in product.images[1:] %}
                                            <img src="{{ extra_img }}" alt="{{ product.name }} {{ loop.index }}" style="padding: 2rem;">
                                        {% endfor %}
                                    {% endif %}
                                </div>

                                {% if product.images and product.images|length > 1 %}
                                    <button class="carousel-arrow prev" onclick="moveCarousel(event, this, -1)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="carousel-arrow next" onclick="moveCarousel(event, this, 1)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <div class="carousel-indicators">
                                        <div class="indicator-dot active"></div>
                                        {% for extra_img in product.images[1:] %}
                                            <div class="indicator-dot"></div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                
                                {% if product.in_stock == False %}
                                    <div class="out-of-stock-overlay">
                                        <span>Jashtë Stokut</span>
                                    </div>
                                {% endif %}
                                
                                <a href="{{ url_for('main.product_detail', product_id=product._id) }}" style="position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 1;"></a>
                            </div>

                            <!-- Info Area -->
                            <div class="fav-info" style="padding: 1.5rem;">
                                <h4 style="font-size: 1.1rem; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600;">
                                    <a href="{{ url_for('main.product_detail', product_id=product._id) }}" style="text-decoration: none; color: var(--text-main);">{{ product.name }}</a>
                                </h4>
                                <div class="price" style="font-weight: 700; color: var(--primary); margin-bottom: 1.5rem; font-size: 1.25rem;">
                                    {% if product.discount_price %}
                                        €{{ product.discount_price }} <small class="text-muted" style="text-decoration: line-through; font-weight: 400; font-size: 0.85rem; margin-left: 5px;">€{{ product.price }}</small>
                                    {% else %}
                                        €{{ product.price }}
                                    {% endif %}
                                </div>
                                
                                <form action="{{ url_for('cart.add_to_cart', product_id=product._id) }}" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-primary" style="width: 100%; border-radius: 1rem; padding: 0.8rem; justify-content: center;" {% if product.in_stock == False %}disabled{% endif %}>
                                        <i class="fas fa-shopping-bag"></i> {{ 'Jashtë Stokut' if product.in_stock == False else 'Shto në Shportë' }}
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state" style="text-align: center; padding: 2.5rem 2rem; background: white; border-radius: 2rem; border: 2px dashed #e2e8f0; box-shadow: var(--shadow-sm); flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="width: 100px; height: 100px; background: #fff1f2; color: #fda4af; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; font-size: 3rem;">
                        <i class="far fa-heart"></i>
                    </div>
                    <h4 style="color: var(--text-main); font-size: 1.5rem; margin-bottom: 2.5rem;">Ju nuk keni produkte të preferuara</h4>
                    <a href="{{ url_for('main.products') }}" class="btn btn-primary" style="padding: 1rem 2.5rem; border-radius: var(--radius-full);">
                        Eksploro Dyqanin <i class="fas fa-arrow-right" style="margin-left: 0.5rem;"></i>
                    </a>
                </div>
            {% endif %}
        </main>
    </div>
</div>

<style>
    @media (max-width: 900px) {
        .profile-wrapper {
            grid-template-columns: 1fr !important;
            gap: 2rem !important;
        }
        .profile-sidebar {
            position: relative !important;
            top: 0 !important;
        }
    }
    .favorite-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
    }
    .favorite-card:hover img {
        transform: scale(1.05);
    }
    .remove-fav:hover {
        background: #ef4444 !important;
        color: white !important;
        transform: rotate(90deg);
    }
</style>

<script>
    // Custom wrapper for remove to animate removal
    async function removeFavorite(btn, productId) {
        if(typeof window.toggleFavorite === 'function') {
            const card = btn.closest(".favorite-card");
            card.style.opacity = "0.5";
            
            const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");
            try {
                const response = await fetch(`/product/favorite/${productId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    card.style.transform = "scale(0.8)";
                    card.style.opacity = "0";
                    setTimeout(() => {
                        card.remove();
                        if(document.querySelectorAll(".favorite-card").length === 0) {
                            location.reload();
                        }
                    }, 300);
                    showToast("Produkti u largua nga të preferuarat", "info");
                } else {
                    card.style.opacity = "1";
                }
            } catch (e) {
                card.style.opacity = "1";
                console.error(e);
            }
        }
    }
</script>
{% endblock %}
