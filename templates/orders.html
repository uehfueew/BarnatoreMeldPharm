{% extends "profile_layout.html" %}

{% block profile_content %}
<div class="profile-card-main">
    <div class="content-header">
        <h2 class="section-title">
            <i class="fas fa-box"></i> Porositë e Mia
        </h2>
        <p class="section-subtitle">Historia e blerjeve tuaja</p>
    </div>

    {% if guest_access %}
        <div class="empty-state-wishlist mt-4">
            <div class="empty-icon"><i class="fas fa-lock"></i></div>
            <h4>Ju duhet të kyçeni</h4>
            <p>Ju lutem kyçuni për të parë historinë e porosive.</p>
            <a href="{{ url_for('auth.login') }}" class="btn btn-primary mt-3">Kyçuni Këtu</a>
        </div>
    {% elif orders %}
        <div class="table-responsive">
            <table class="table admin-table fade-in">
                <thead>
                    <tr>
                        <th style="width: 12%;">ID</th>
                        <th style="width: 25%;">Porosia</th>
                        <th style="width: 18%;" class="date-col">Data</th>
                        <th style="width: 10%;">Totali</th>
                        <th style="width: 20%;">Statusi</th>
                        <th style="width: 15%;">Veprime</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr class="order-row">
                        <td><small>#{{ order._id|string|truncate(6, True, '') }}</small></td>
                        <td>
                            Porosia Juaj<br>
                            <small class="text-muted">{{ order['items']|length }} {{ 'Produkt' if order['items']|length == 1 else 'Produkte' }}</small>
                        </td>
                        <td class="date-col">{{ order.created_at.strftime('%d-%m-%Y') }}</td>
                        <td class="order-total">€{{ "%.2f"|format(order.grand_total) }}</td>
                        <td>
                            {% if order.status == 'Received' %}
                                <span class="status-badge status-received">Pranuar</span>
                            {% elif order.status == 'Cancelled' %}
                                <span class="status-badge status-cancelled">Anuluar</span>
                            {% else %}
                                <span class="status-badge status-pending">Në Proces</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="toggleDetails('{{ order._id }}')">
                                Detajet
                            </button>
                        </td>
                    </tr>
                    <tr id="details-{{ order._id }}" style="display: none; background-color: #f8fafc;">
                        <td colspan="6">
                            <div class="order-details-wrapper">
                                <div class="admin-details-grid">
                                    <div class="details-section">
                                        <h5 class="details-title">Informacionet e Dërgesës</h5>
                                        <p><strong>Emri:</strong> {{ order.fullname }}</p>
                                        <p><strong>Adresa:</strong> {{ order.address }}, {{ order.city }}</p>
                                        <p><strong>Telefoni:</strong> {{ order.phone }}</p>
                                        <p><strong>Pagesa:</strong> {{ order.payment_method }}</p>
                                    </div>
                                    <div class="details-section">
                                        <h5 class="details-title">Produktet</h5>
                                        <ul class="details-products-admin">
                                            {% for item in order['items'] %}
                                                <li>
                                                    <span>{{ item.quantity }}x {{ item.name }}</span>
                                                    <strong class="details-price">€{{ "%.2f"|format(item.item_total) }}</strong>
                                                </li>
                                            {% endfor %}
                                            <li class="admin-total-row">
                                                <strong>Total: €{{ "%.2f"|format(order.grand_total) }}</strong>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state-wishlist mt-4">
            <div class="empty-icon"><i class="fas fa-shopping-bag"></i></div>
            <h4>Nuk keni bërë asnjë porosi ende</h4>
            <p>Filloni blerjen për të parë porositë tuaja këtu.</p>
            <a href="{{ url_for('main.products') }}" class="btn btn-primary mt-3">Fillo Blerjen</a>
        </div>
    {% endif %}
</div>

<style>
    /* Import Admin Styles for Table Consistency */
    .admin-table { width: 100%; border-collapse: separate; border-spacing: 0 0.5rem; background: transparent !important; }
    .admin-table thead th { background: #f8fafc; padding: 1rem; font-size: 0.8rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border: none; }
    .admin-table tbody tr:not([id^="details-"]) { background: white; transition: all 0.2s ease; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .admin-table td { padding: 1.25rem 1rem; vertical-align: middle; border-top: 1px solid #f1f5f9; }
    .admin-table tbody tr:not([id^="details-"]):hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    
    .status-badge { padding: 0.4rem 0.8rem; border-radius: 2rem; font-size: 0.75rem; font-weight: 700; display: inline-block; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-received { background: #dcfce7; color: #166534; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }

    .order-details-wrapper { padding: 1.5rem; background: #f8fafc; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
    .admin-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .details-title { font-size: 1rem; margin-bottom: 0.6rem; color: var(--text-main); font-weight: 600; }
    .details-products-admin { list-style: none; padding: 0; margin: 0; }
    .details-products-admin li { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }
    .admin-total-row { margin-top: 0.75rem; text-align: right; font-size: 0.9rem; }
    .details-price { color: var(--primary); font-weight: 600; }

    .empty-state-wishlist { background: white; border-radius: 1.5rem; padding: 4rem 2rem; text-align: center; border: 2px dashed #e2e8f0; }
    .empty-icon { width: 80px; height: 80px; background: #f1f5f9; color: #94a3b8; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 1.5rem; }

    @media (max-width: 992px) {
        .admin-details-grid { grid-template-columns: 1fr !important; gap: 1rem !important; }
        .order-details-wrapper { padding: 0.85rem !important; }
        .details-title { font-size: 0.85rem !important; }
        .details-products-admin li { font-size: 0.75rem !important; padding: 0.3rem 0 !important; }
        .admin-total-row { font-size: 0.8rem !important; }
        .order-details-wrapper p { font-size: 0.75rem !important; margin-bottom: 0.3rem !important; }
    }
</style>

<script>
function toggleDetails(id) {
    const el = document.getElementById('details-' + id);
    if (el.style.display === 'none' || el.style.display === '') {
        el.style.display = 'table-row';
    } else {
        el.style.display = 'none';
    }
}
</script>
{% endblock %}
