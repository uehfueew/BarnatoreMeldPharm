{% extends "base.html" %}

{% block title %}{{ 'Ndrysho Produktin' if product else 'Shto Produkt Të Ri' }}{% endblock %}

{% block content %}
<div class="form-container section-container">
    <h2 class="section-title" style="font-size: 1.5rem; margin-bottom: 2rem;">{{ 'Ndrysho Produktin' if product else 'Shto Produkt Të Ri' }}</h2>
    
    <form method="POST" class="auth-form product-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="form-group">
            <label for="name">Emri i Produktit</label>
            <input type="text" id="name" name="name" class="form-control" value="{{ product.name if product else '' }}" required>
        </div>

        <div class="form-group">
            <label for="brand">Marka (Brand)</label>
            <input type="text" id="brand" name="brand" class="form-control" value="{{ product.brand if product else '' }}" required placeholder="Psh: Eucerin, Vichy, La Roche-Posay">
        </div>
        
        <div class="form-group">
            <label for="category">Kategoria Kryesore</label>
            <select id="category" name="category" class="form-control" required>
                <option value="">Zgjidh Kategorinë</option>
                {% for cat_name in categories.keys() %}
                    <option value="{{ cat_name }}" {% if product and product.category == cat_name %}selected{% endif %}>{{ cat_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="subcategory">Nënkategoria</label>
            <select id="subcategory" name="subcategory" class="form-control" required>
                <option value="">Së pari zgjidhni kategorinë</option>
                {% if product and product.subcategory %}
                    <option value="{{ product.subcategory }}" selected>{{ product.subcategory }}</option>
                {% endif %}
            </select>
        </div>

        <div class="form-group">
            <label for="size">Sasia (p.sh. 50ml, 200g, 30 Kapsula)</label>
            <input type="text" id="size" name="size" class="form-control" value="{{ product.size if product else '' }}" placeholder="Psh: 50ml, 100g">
        </div>
        
        <div class="form-group">
            <label for="price">Çmimi (€)</label>
            <input type="number" id="price" name="price" step="0.01" min="0" class="form-control" 
                   value="{{ product.price if product else '' }}" 
                   required placeholder="0.00">
        </div>
        
        <div class="form-group">
            <label for="discount_price">Çmimi me Zbritje (Opsionale)</label>
            <input type="number" id="discount_price" name="discount_price" step="0.01" min="0" class="form-control" 
                   value="{{ product.discount_price if product else '' }}"
                   placeholder="0.00">
        </div>

        <div class="form-group {% if not product or not product.discount_price %}d-none{% endif %}" id="discount-until-group">
            <label for="discount_until">Data kur përfundon oferta (Opsionale)</label>
            {% set discount_val = "" %}
            {% if product and product.discount_until %}
                {% if product.discount_until.strftime %}
                    {% set discount_val = product.discount_until.strftime('%Y-%m-%d') %}
                {% else %}
                    {% set discount_val = product.discount_until[:10] %}
                {% endif %}
            {% endif %}
            <input type="date" id="discount_until" name="discount_until" class="form-control" value="{{ discount_val }}">
            <small class="form-text text-muted">Pas kësaj date, produkti do të kthehet automatikisht në çmimin normal.</small>
        </div>
        
        <div class="form-group">
            <label for="image_url">Linku i imazhit kryesor (URL)</label>
            <input type="url" id="image_url" name="image_url" class="form-control" value="{{ product.image_url if product else '' }}" required placeholder="https://...">
        </div>

        <div class="form-group">
            <label for="additional_images">Imazhe shtesë (URL, një në cdo rresht)</label>
            <textarea id="additional_images" name="additional_images" class="form-control" rows="4" placeholder="https://example.com/image2.jpg&#10;https://example.com/image3.jpg">{% if product and product.images %}{% for img in product.images %}{% if img != product.image_url %}{{ img }}&#10;{% endif %}{% endfor %}{% endif %}</textarea>
        </div>
        
        <div class="form-group">
            <label for="description">Përshkrimi</label>
            <textarea id="description" name="description" class="form-control" rows="4">{{ product.description if product else '' }}</textarea>
        </div>
        
        <div class="form-group checkbox-group">
            <input type="checkbox" id="in_stock" name="in_stock" {% if product is none or product.in_stock %}checked{% endif %}>
            <label for="in_stock">Në Stok?</label>
        </div>
        
        <div class="form-group checkbox-group">
            <input type="checkbox" id="featured" name="featured" {% if product and product.featured %}checked{% endif %}>
            <label for="featured">Produkt i Veçuar (Featured)?</label>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="is_best_seller" name="is_best_seller" {% if product and product.is_best_seller %}checked{% endif %}>
            <label for="is_best_seller">Më i Shituri (Best Seller)?</label>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block">{{ 'Përditëso' if product else 'Krijo' }}</button>
    </form>
</div>

<script id="product-form-config" type="application/json">
{
    "categories": {{ categories|tojson | safe }},
    "currentSubcategory": {{ (product.get('subcategory', '') if product else '') | tojson | safe }}
}
</script>

<script>
    const config = JSON.parse(document.getElementById('product-form-config').textContent);
    const categoriesData = config.categories;
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory');
    const currentSubcategory = config.currentSubcategory;

    function updateSubcategories() {
        const selectedCategory = categorySelect.value;
        const subcategories = categoriesData[selectedCategory] || [];
        
        // Clear previous options
        subcategorySelect.innerHTML = '<option value="">Zgjidh Nënkategorinë</option>';
        
        subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            if (sub === currentSubcategory) {
                option.selected = true;
            }
            subcategorySelect.appendChild(option);
        });
    }

    categorySelect.addEventListener('change', updateSubcategories);
    
    // Initialize on load if category already selected
    if (categorySelect.value) {
        updateSubcategories();
    }

    // Toggle discount until date based on discount price
    const discountPriceInput = document.getElementById('discount_price');
    const discountUntilGroup = document.getElementById('discount-until-group');
    const discountUntilInput = document.getElementById('discount_until');

    if (discountPriceInput && discountUntilGroup) {
        discountPriceInput.addEventListener('input', function() {
            if (this.value && parseFloat(this.value) > 0) {
                discountUntilGroup.style.display = 'block';
            } else {
                discountUntilGroup.style.display = 'none';
                if (discountUntilInput) discountUntilInput.value = '';
            }
        });
    }
</script>
{% endblock %}
