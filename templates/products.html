{% extends "base.html" %}

{% block content %}
<section class="section shop-section">
    <div class="container container-wide">
        <div class="shop-layout">
            <!-- Sidebar Filters -->
            <aside class="shop-sidebar" id="shopSidebar">
                <div class="sidebar-mobile-header">
                    <button class="btn-close-sidebar" id="closeSidebar" onclick="closeShopSidebar()"><i class="fas fa-times"></i></button>
                    <h3>Filtroni Produktet</h3>
                </div>
                <div class="sidebar-content-wrapper">
                    <div class="sidebar-block collapsible-sidebar-block" id="categoryBlock">
                        <button class="sidebar-collapsible-trigger" onclick="toggleFilterSection(this)">
                            <h3 class="sidebar-title no-line">Kategoritë</h3>
                            <i class="fas fa-chevron-down toggle-chevron"></i>
                        </button>
                        <div class="collapsible-content">
                            <ul class="sidebar-cat-list">
                                <li>
                                    <a href="{{ url_for('main.products', category='all') }}" class="sidebar-cat-link {% if current_category == 'all' %}active{% endif %}">
                                        <span>Të Gjitha</span>
                                        <i class="fas fa-th-large"></i>
                                    </a>
                                </li>
                                {% for cat_name, subcats in categories.items() %}
                                <li>
                                    <div class="sidebar-cat-group">
                                        <a href="{{ url_for('main.products', category=cat_name) }}" class="sidebar-cat-link {% if current_category == cat_name %}active{% endif %}">
                                            <span>{{ cat_name }}</span>
                                            {% if subcats %}<i class="fas fa-chevron-right toggle-icon"></i>{% endif %}
                                        </a>
                                        {% if current_category == cat_name and subcats %}
                                        <ul class="sidebar-subcat-list">
                                            {% for sub in subcats %}
                                            <li>
                                                <a href="{{ url_for('main.products', category=cat_name, subcategory=sub) }}" class="sidebar-subcat-link {% if current_subcategory == sub %}active{% endif %}">
                                                    {{ sub }}
                                                </a>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Only Discounts Filter -->
                    <div class="sidebar-block">
                        <h3 class="sidebar-title">Statusi</h3>
                        <div class="filter-switch-row mb-3">
                            <span class="switch-label">Shfaq vetëm ofertat</span>
                            <label class="switch">
                                <input type="checkbox" id="discount-only-filter" {% if discount_only %}checked{% endif %} onchange="updateShop()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="filter-switch-row">
                            <span class="switch-label">Më të shiturit</span>
                            <label class="switch">
                                <input type="checkbox" id="best-seller-filter" {% if best_sellers %}checked{% endif %} onchange="updateShop()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Brand Filter -->
                    <div class="sidebar-block collapsible-sidebar-block" id="brandBlock">
                        <button class="sidebar-collapsible-trigger" onclick="toggleFilterSection(this)">
                            <h3 class="sidebar-title">Brendet</h3>
                            <i class="fas fa-chevron-down toggle-chevron"></i>
                        </button>
                        <div class="collapsible-content">
                            <div class="brand-filter-container">
                                <ul class="brand-list">
                                    <li>
                                        <a href="{{ url_for('main.products', brand='all', category=current_category) }}" class="brand-link-item {% if current_brand == 'all' %}active{% endif %}">
                                            Të gjitha
                                        </a>
                                    </li>
                                    {% for brand in brands %}
                                    <li>
                                        <a href="{{ url_for('main.products', brand=brand, category=current_category) }}" class="brand-link-item {% if current_brand == brand %}active{% endif %}">
                                            {{ brand }}
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-block clickable-last-block">
                        <h3 class="sidebar-title">Çmimi</h3>
                        <div class="filter-group-price">
                            <div class="price-inputs-wrapper" style="margin-bottom: 1rem;">
                                <div class="input-with-label">
                                    <span>Min</span>
                                    <input type="number" placeholder="0" id="min-price" class="price-input" value="{{ request.args.get('min_price', '') }}">
                                </div>
                                <div class="input-with-label">
                                    <span>Max</span>
                                    <input type="number" placeholder="1000" id="max-price" class="price-input" value="{{ request.args.get('max_price', '') }}">
                                </div>
                            </div>
                            <button id="apply-price-filter" class="btn btn-sm btn-primary w-100" onclick="updateShop()">Apliko Çmimin</button>
                        </div>
                    </div>
                </div> <!-- End sidebar-content-wrapper -->
                <div class="sidebar-mobile-footer d-md-none">
                    <button class="btn btn-primary w-100" onclick="closeShopSidebar()">Shiko Produktet</button>
                </div>
            </aside>
            
            <!-- Main Shop Content -->
            <main class="shop-main-content">
                <div class="shop-controls-container">
                    <div class="results-count">
                        Gjithsej <span id="current-count">{{ total_count }}</span> produkte
                    </div>
                    <div class="shop-sorting" style="display: flex; gap: 0.5rem; align-items: center;">
                        <div class="dropdown" id="sortDropdown">
                            <button class="btn btn-outline-secondary order-button" type="button" id="sortTrigger">
                                Rendit: <span id="current-sort-label">Relevanca</span> <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end" id="sortMenu">
                                <a class="dropdown-item sort-trigger active" data-sort="relevance">
                                    <i class="fas fa-star"></i> Relevanca
                                </a>
                                <a class="dropdown-item sort-trigger" data-sort="price-low">
                                    <i class="fas fa-sort-amount-down-alt"></i> Çmimi: Ulët - Lartë
                                </a>
                                <a class="dropdown-item sort-trigger" data-sort="price-high">
                                    <i class="fas fa-sort-amount-up"></i> Çmimi: Lartë - Ulët
                                </a>
                                <a class="dropdown-item sort-trigger" data-sort="newest">
                                    <i class="fas fa-clock"></i> Më të rejat
                                </a>
                                <a class="dropdown-item sort-trigger" data-sort="discount">
                                    <i class="fas fa-tag"></i> Zbritjes (%) më të lartë
                                </a>
                            </div>
                        </div>
                        <button class="btn btn-outline-secondary filter-mobile-toggle" onclick="openShopSidebar()">
                             <i class="fas fa-sliders-h"></i> <span>Filtro</span>
                        </button>
                    </div>
                </div>

                <div id="productGrid" class="product-grid-v2">
                    {% for product in products %}
                        <div class="product-card fade-in-section">
                            <div class="product-image">
                                {% if product.discount_price %}
                                    <div class="special-offer-badge red-badge">Oferta Speciale</div>
                                {% endif %}
                                {% if product.is_best_seller %}
                                    <div class="best-seller-badge">Më i Shituri</div>
                                {% endif %}
                                <img src="{{ product.image_url }}" alt="{{ product.name }}">
                                <button class="btn-favorite {{ 'active' if (current_user.is_authenticated and product.favorites and current_user.id in product.favorites) or (not current_user.is_authenticated and product._id|string in session.get('liked_products', [])) else '' }}" onclick="toggleFavorite(this, '{{ product._id }}')">
                                    <i class="{{ 'fas' if (current_user.is_authenticated and product.favorites and current_user.id in product.favorites) or (not current_user.is_authenticated and product._id|string in session.get('liked_products', [])) else 'far' }} fa-heart"></i>
                                </button>
                                <a href="{{ url_for('main.product_detail', product_id=product._id) }}" class="product-card-link-overlay"></a>
                            </div>
                            <div class="product-info">
                                <span class="product-category">{{ product.category }}</span>
                                <h3 class="product-title">{{ product.name }}</h3>
                                {% if product.size %}<span class="product-size">{{ product.size }}</span>{% endif %}
                                <div class="price-container">
                                    {% if product.discount_price %}
                                        <span class="price discounted">€{{ product.discount_price }}</span>
                                        <span class="price original">€{{ product.price }}</span>
                                        <span class="discount-badge">-{{ ((product.price - product.discount_price) / product.price * 100)|round|int }}%</span>
                                    {% else %}
                                        <span class="price">€{{ product.price }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    
                    {% if not products %}
                        <div class="empty-state" style="grid-column: 1/-1; padding: 4rem; text-align: center;">
                            <i class="fas fa-search fa-3x mb-3" style="color: #cbd5e1;"></i>
                            <p>Nuk u gjetën produkte në këtë kategori.</p>
                            <a href="{{ url_for('main.products') }}" class="btn btn-primary mt-3">Shiko të gjitha</a>
                        </div>
                    {% endif %}
                </div>

                <div class="load-more-container text-center {{ 'd-none' if not total_pages or total_pages <= 1 else '' }}" style="margin-top: 4rem; margin-bottom: 4rem;">
                    <button id="load-more-products" class="btn btn-load-more" data-page="1" onclick="window.updateShop(true)">
                        Shiko të gjitha <i class="fas fa-chevron-down ml-2"></i>
                    </button>
                </div>
            </main>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeShopSidebar()"></div>
</section>
{% endblock %}
